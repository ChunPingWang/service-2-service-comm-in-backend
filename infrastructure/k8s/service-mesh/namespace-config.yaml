# Namespace Configuration for Istio Service Mesh
#
# Sidecar injection for the "poc" namespace is already enabled via the
# "istio-injection: enabled" label in infrastructure/k8s/namespaces.yaml.
#
# This file provides supplementary mesh configuration for the namespace:
# - PodDisruptionBudget for istio-proxy stability during rolling updates
# - Reference documentation for the sidecar injection setup
#
# When Istio detects the "istio-injection: enabled" label on a namespace,
# it automatically injects the istio-proxy sidecar container into every
# new pod created in that namespace via a mutating admission webhook.
#
# To verify sidecar injection is active:
#   kubectl get namespace poc --show-labels
#   kubectl get pods -n poc -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{range .spec.containers[*]}{.name}{", "}{end}{"\n"}{end}'

---
# PodDisruptionBudget ensures that during voluntary disruptions
# (e.g., node drain, cluster upgrade), at least one pod of each
# service remains available so the mesh stays functional.
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: order-service-pdb
  namespace: poc
  labels:
    app: order-service
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: order-service
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: product-service-pdb
  namespace: poc
  labels:
    app: product-service
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: product-service
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: payment-service-pdb
  namespace: poc
  labels:
    app: payment-service
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: payment-service
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: notification-service-pdb
  namespace: poc
  labels:
    app: notification-service
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: notification-service
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: shipping-service-pdb
  namespace: poc
  labels:
    app: shipping-service
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: shipping-service
